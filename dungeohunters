-- ===================== Copy key site to clipboard =====================
pcall(function()
	if setclipboard then
		setclipboard('https://scriptsrbx.com/key/')
	end
end)

-- ===================== Load Rayfield UI (SAFE) =====================
local Rayfield
local okUI, err = pcall(function()
	Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
end)

if not okUI or not Rayfield then
	warn("Rayfield failed to load:", err)
	return
end

-- ===================== Key fetcher =====================
local HttpService = game:GetService('HttpService')

local function fetchKeys(url)
	local ok, body = pcall(function() return game:HttpGet(url) end)
	if not ok or not body then return {} end

	local okJson, arr = pcall(function() return HttpService:JSONDecode(body) end)
	if okJson and type(arr) == "table" then
		local t = {}
		for _, k in ipairs(arr) do
			if type(k) == "string" and #k > 0 then table.insert(t, k) end
		end
		return t
	end

	local out = {}
	body = body:gsub("\r", "\n")
	for key in body:gmatch("[^\n,]+") do
		key = key:match("^%s*(.-)%s*$")
		if key ~= "" then table.insert(out, key) end
	end
	return out
end

local KEYS_URL = "https://raw.githubusercontent.com/ScriptsRBXdotCom/scripts/refs/heads/main/Keys"
local KEY_LIST = fetchKeys(KEYS_URL)
if #KEY_LIST == 0 then
	KEY_LIST = { "ScriptsRBX-DFAD3" }
end

-- ===================== UI Window =====================
local Window = Rayfield:CreateWindow({
	Name = 'Auto Farm | ScriptsRBX',
	LoadingTitle = 'ScriptsRBX.com Auto Farm',
	LoadingSubtitle = 'ScriptsRBX',
	Theme = 'Default',
	ShowText = 'Auto Farm GUI',
	ToggleUIKeybind = 'K',
	KeySystem = false,
})

if not Window then
	warn("Window failed to create (Rayfield issue)")
	return
end

-- =====================================================================
--          PERFECT HOVER FARM + REMOTE SPAM + RECYCLE CLEANER (UPDATED)
-- =====================================================================

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local CreatureController = ReplicatedStorage
    :WaitForChild("Creature")
    :WaitForChild("Script")
local CreatureClient = require(CreatureController:WaitForChild("CreatureControllerClient"))

local LP = Players.LocalPlayer
local function getChar()
    local c = LP.Character or LP.CharacterAdded:Wait()
    c:WaitForChild("HumanoidRootPart")
    return c
end

local Char = getChar()
local HRP = Char:WaitForChild("HumanoidRootPart")

LP.CharacterAdded:Connect(function()
    Char = getChar()
    HRP = Char:WaitForChild("HumanoidRootPart")
end)

-- Remote
local ClientApplyServerActivateGA = ReplicatedStorage
    :WaitForChild("GameplayAbilitySystem")
    :WaitForChild("Remote")
    :WaitForChild("ClientApplyServerActivateGA")

-- Monster folder
local ActivationFolder = workspace:WaitForChild("Creature"):WaitForChild("Activation")

-- ‚≠ê Get ALL monsters in the world
local function getAllMonsters()
    local monsters = {}

    for _, node in ipairs(ActivationFolder:GetChildren()) do
        for _, obj in ipairs(node:GetChildren()) do

            if obj:IsA("Model")
            and obj:FindFirstChild("Head")
            and (
                obj.Name:match("^Monster%d*$")
                or obj.Name:match("^Boss%d*$")
                or obj.Name:match("^EliteMonster%d*$")
                or obj.Name:match("^StakeMonster%d*$")
                or obj.Name:match("^Box%d*$")
            ) then
                table.insert(monsters, obj)
            end
        end
    end

    return monsters
end

-- ‚≠ê Always pick nearest
local function getNearestMonster()
    if not HRP then return nil end

    local closest, bestDist = nil, math.huge

    for _, mob in ipairs(getAllMonsters()) do
        local head = mob:FindFirstChild("Head")
        if head then
            local d = (HRP.Position - head.Position).Magnitude
            if d < bestDist then
                bestDist = d
                closest = mob
            end
        end
    end

    return closest
end

-- ‚≠ê Hover above monster
local function hoverAbove(monster)
    if not (monster and HRP) then return end

    local hrpMob = monster:FindFirstChild("HumanoidRootPart") or monster:FindFirstChild("Head")
    if not hrpMob then return end

    local lookDir = hrpMob.CFrame.LookVector
    local pos = hrpMob.Position + (lookDir * -5) + Vector3.new(0, 1.5, 0)

    HRP.Velocity = Vector3.new(0,0,0)
    HRP.AssemblyLinearVelocity = Vector3.new(0,0,0)

    HRP.CFrame = CFrame.new(pos, hrpMob.Position)
end

-- ‚≠ê AutoFarm Loop
local AutoFarm = false

local function startAutoFarm()
    task.spawn(function()

        -- Remote spam loop
        task.spawn(function()
            while AutoFarm do
                pcall(function()
                    ClientApplyServerActivateGA:InvokeServer("10016", "17", {})
                end)
                task.wait(0.05)
            end
        end)

        -- Cleanup "Recycle" folder spam
        task.spawn(function()
            while AutoFarm do
                local recycle = workspace:FindFirstChild("Recycle")
                if recycle then recycle:Destroy() end
                task.wait(0.1)
            end
        end)

        -- ‚≠ê‚≠ê MAIN AUTO FARM LOOP ‚≠ê‚≠ê
        while AutoFarm do
            
            local mobs = getAllMonsters()
            if #mobs == 0 then
                task.wait(0.1)
                continue
            end

            -- Get nearest mob *every cycle*
            local target = getNearestMonster()
            if not target then
                task.wait(0.1)
                continue
            end

            local startT = tick()

            -- Follow mob
            while AutoFarm do
                
                -- If mob no longer valid ‚Üí retarget
                if not target.Parent
                or not target:FindFirstChild("Head")
                or not target:IsDescendantOf(ActivationFolder) then
                    break
                end

                -- Anti-void
                if HRP.Position.Y < -20 then
                    local head = target:FindFirstChild("Head")
                    if head then
                        HRP.CFrame = CFrame.new(head.Position + Vector3.new(0, 3, 0))
                    end
                end

                -- Timeout ‚Üí force target refresh
                if tick() - startT > 5 then
                    break
                end

                hoverAbove(target)
                task.wait(0.03)
            end
        end
    end)
end


----------------------------------------------------
-- AUTO VOTE SYSTEM
----------------------------------------------------

local RS = game:GetService("ReplicatedStorage")
local Dungeon = RS:WaitForChild("Dungeon")
local CastVote = Dungeon.Bindable:WaitForChild("CastVote")

local AutoVote = false

spawn(function()
    while task.wait(1) do
        if AutoVote then
            pcall(function()
                CastVote:Invoke(1) -- EXP DOOR ONLY
            end)
        end
    end
end)

local VirtualInputManager = game:GetService("VirtualInputManager")
_G.AutoKeys = false

function StartKeySpam()
    if _G.AutoKeys then return end
    _G.AutoKeys = true

    task.spawn(function()
        while _G.AutoKeys do
            VirtualInputManager:SendKeyEvent(true, "Q", false, game)
            VirtualInputManager:SendKeyEvent(false, "Q", false, game)
            task.wait(0.2)

            VirtualInputManager:SendKeyEvent(true, "E", false, game)
            VirtualInputManager:SendKeyEvent(false, "E", false, game)
            task.wait(0.2)

            VirtualInputManager:SendKeyEvent(true, "R", false, game)
            VirtualInputManager:SendKeyEvent(false, "R", false, game)
            task.wait(1)
        end
    end)
end

function StopKeySpam()
    _G.AutoKeys = false
end


-- =====================================================================
--                     RAYFIELD UI BUTTON
-- =====================================================================

local FarmTab = Window:CreateTab("AutoFarm", 4483362458)

FarmTab:CreateToggle({
	Name = "AutoFarm",
	CurrentValue = false,
	Callback = function(on)
		AutoFarm = on
		if on then
			startAutoFarm()
		end
	end,
})


FarmTab:CreateToggle({
    Name = "Auto Vote Door",
    Default = false,
    Callback = function(state)
        AutoVote = state
    end
})

FarmTab:CreateToggle({
    Name = "Auto Skills",
    CurrentValue = false,
    Callback = function(state)
        if state then StartKeySpam() else StopKeySpam() end
    end
})

FarmTab:CreateLabel("üöß More Features Coming Soon...")
